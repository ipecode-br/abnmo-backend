name: Deploy Lambda to AWS

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    name: Build and Deploy Lambda
    runs-on: ubuntu-latest
    environment: development
    permissions:
      id-token: write # Permite a obten√ß√£o do token OIDC
      contents: read # Permiss√£o comum para checkout do c√≥digo

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build and package Lambda
        run: npx ts-node scripts/build-lambda.ts

      - name: Set Lambda function name and NODE_ENV based on branch
        id: set-lambda-env
        run: |
          echo "Detected branch: ${{ github.ref_name }}"
          if [ "${{ github.ref_name }}" = "dev" ]; then
            echo "LAMBDA_NAME=ipecode-abnmo-lambda-backend-dev" >> $GITHUB_ENV
            echo "NODE_ENV=development" >> $GITHUB_ENV
          elif [ "${{ github.ref_name }}" = "homolog" ]; then
            echo "LAMBDA_NAME=ipecode-abnmo-lambda-backend-homolog" >> $GITHUB_ENV
            echo "NODE_ENV=homolog" >> $GITHUB_ENV
          elif [ "${{ github.ref_name }}" = "main" ]; then
            echo "LAMBDA_NAME=ipecode-abnmo-lambda-backend-main" >> $GITHUB_ENV
            echo "NODE_ENV=production" >> $GITHUB_ENV
          else
            echo "Branch not supported: ${{ github.ref_name }}"
            exit 1
          fi

      - name: Configure AWS credentials with OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: Upload Lambda & set env vars
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          NODE_ENV: ${{ env.NODE_ENV }}
          API_BASE_URL: ${{ env.API_BASE_URL }}
          API_PORT: ${{ env.API_PORT }}
        run: |
          if [ ! -f lambda.zip ]; then
            echo "‚ùå lambda.zip not found!"
            exit 1
          fi
          echo "üöÄ Deploying to Lambda: $LAMBDA_NAME"

          echo "DB_HOST=${DB_HOST:0:3}***"
          echo "NODE_ENV=$NODE_ENV"
          echo "API_BASE_URL=$API_BASE_URL"
          echo "API_PORT=$API_PORT"

          aws lambda update-function-configuration \
            --function-name $LAMBDA_NAME \
            --environment "Variables={\
              DB_HOST=$DB_HOST,\
              DB_PORT=$DB_PORT,\
              DB_DATABASE=$DB_DATABASE,\
              DB_USERNAME=$DB_USERNAME,\
              DB_PASSWORD=$DB_PASSWORD,\
              NODE_ENV=$NODE_ENV,\
              API_BASE_URL=$API_BASE_URL,\
              API_PORT=$API_PORT\
              }"

          aws lambda update-function-code \
            --function-name $LAMBDA_NAME \
            --zip-file fileb://lambda.zip